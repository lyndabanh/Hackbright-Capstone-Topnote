{% extends 'base.html' %}

{% block title %}{{ wine.title }} - Details{% endblock %}

{% block body %}
  <a href="/">Home</a>
  {% if 'user_id' in session %}
      <a href="/users/{{ user.user_id }}">My Cellar</a>
  {% endif %}
<div></div>
<h1>{{ wine.title }}</h1>
<h2>Wine profile</h2>

<p>
  <div>Designation: {{ wine.designation }}</div>
  <div>Varietal: {{ wine.variety }}</div>
  <div>Region 1: {{ wine.region_1 }}</div>
  <div>Region 2: {{ wine.region_2 }}</div>
  <div>Province: {{ wine.province }}</div>
  <div>Country: {{ wine.country }}</div>
  <div>Winery: {{ wine.winery }}</div>
  <div>Description: {{ wine.description }}</div>
  <div>Critic Rating: {{ wine.points }}</div>
</p>
  

<h2>Rate or Favorite this Wine!</h2>
{% if 'user_id' in session %}
{% if current_users_fav %}
  <form action="/wines/{{ wine.wine_id }}/ratings" method="POST">
    <p>
      <button type="submit" value="Unfavorite" name="unfavorite">Unfavorite</button>
    </p>
  {% else %}
  <form action="/wines/{{ wine.wine_id }}/ratings" method="POST">
    <p>
      <button type="submit" value="Favorite" name="favorite">Favorite</button>
    </p>
  {% endif %}

  {% if current_users_rating %}
  <p>You've already rated this wine. You may update your rating below:</p>
  <form action="/wines/{{ wine.wine_id }}/ratings" method="POST">
    <p>
      Update rating<input type="number" min="0" max=100 name="new_rating">
      Update comment<input type="text" name="new_comment">
    </p>

    <p>
      <input type="submit" value="Update">
    </p>
  </form>
  {% else %}
    <form action="/wines/{{ wine.wine_id }}/ratings" method="POST">
      <p>
        Rating<input type="number" min="0" max=100 name="rating">
        Add comment<input type="text" name="comment">
      </p>

      <p>
        <input type="submit" value="Rate">
      </p>
    </form>
  {% endif %}

{% endif %}

{% if not 'user_id' in session %}
  <p>
    <div>Log in to rate or favorite this wine!</div> 
    <div>(Login on homepage)</div>
  </p>
{% endif %}


<form action="/wines/{{ wine.wine_id }}/ratings"></form>
<input type="submit">

<button id="favorite" class="favoriteText">Favorite</button>
<script>
  "use strict";
  
  const btn = document.querySelector('#favorite');
  
  btn.addEventListener('click', () => {
    if(btn.innerHTML === 'Unfavorite') {
      btn.innerHTML = 'Favorite';
    } else {
      btn.innerHTML = 'Unfavorite';
    }
  });
</script>
<p>
<div>TODO: If adding comment, add to same HTML form as rating</div>
<div>TODO: JS event listener above has no functionality</div>
<div>TODO: Have favoriting click event render the current page, AJAX?</div>
</p>

<a href="/wines/{{ wine.wine_id }}/ratings">Rating Details about this Wine!</a>

<h2>Wine stats</h2>

{% if num_favorites == 1 %}
  <p>This wine has been favorited {{ num_favorites }} time. </p>
  {% else %}
  <p>This wine has been favorited {{ num_favorites }} times. </p>
{% endif %}

{% if not wine.ratings %}
<p>This wine does not have any ratings yet.</p>
{% endif %}

<p>Critic rating: {{ wine.points }}</p>

{% if wine.ratings %}
<p>Average user rating:{{ average }}</p>
<table>
<tr>
    <th>User</th>
    <th>Rating</th>
</tr>
{% for rating in wine.ratings %}
<tr>
    <td><a href="/users/{{ rating.user.user_id }}">{{ rating.user.name }}</a></td>
    <td>{{ rating.rating }}</td>
</tr>
{% endfor %}
</table>

<p>TODO: Bootstrap tables has sorting function</p>

<table>
    <tr>
        <th>User</th>
        <th>Rating(highest to lowest)</th>
    </tr>
    {% for rating in desc_ordered_ratings %}
    <tr>
        <td><a href="/users/{{ rating.user.user_id }}">{{ rating.user.name }}</a></td>
        <td>{{ rating.rating }}</td>
    </tr>
    {% endfor %}
</table>
{%  endif %}

{% endblock %}